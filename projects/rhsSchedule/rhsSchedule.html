<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RHS School Schedule</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0d6635 0%, #b3a369 100%);
      color: #fff;
      text-align: center;
    }

    #container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 1rem;
      width: 100%;  /* use full device width */
      padding: 0.5rem; /* optional padding for spacing from screen edges */
      box-sizing: border-box;
    }

    .block {
      display: inline-flex;
      flex-direction: column;
      border-radius: 15px;
      padding: 1rem 2rem;
      background: #fff;
      border-color: #999999;
      white-space: nowrap;
    }


    h1 {
      font-size: clamp(1rem, 8vw, 75px);
      font-weight: 900;
      white-space: nowrap;
      border-radius: 12px;
      margin: 0;
      color: #0d6635;
      text-shadow: 1px 1px 6px rgba(0,0,0,0.2);
    }

    h2 {
      font-size: clamp(0.8rem, 3vw, 30px);
      margin-top: 1.5rem;
      font-weight: 600;
      border-radius: 12px;
      padding: 2px 10px;
      color: #fff;
      background: #b3a369;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <script>
    // @ts-check

    /**
     * @typedef {Object} ScheduleBlock
     * @property {string} name
     * @property {string} start
     * @property {string} end
     */

    /**
     * @typedef {Object.<string, ScheduleBlock[]>} ScheduleMap
     */

    /**
     * @typedef {Object} FullSchedule
     * @property {ScheduleMap} regularSchedule - The regular weekly schedule.
     * @property {ScheduleMap} specialSchedule - A collection of named special schedules.
     * @property {Object.<string,string>} specialDays - A collection of days that have special
     *  schedules and the specific schedules that should be used on those days.
     */

    /** @type {Promise<FullSchedule> | null} */
    let cachedFullSchedule = null;

    /**
     * Get the full schedule.
     * 
     * @returns {Promise<FullSchedule>}
     */
    function getFullSchedule() {
      if (cachedFullSchedule !== null)
      {
        console.log("Using cached full schedule.");
      }
      else
      {
        console.log("Loading full schedule...");
        cachedFullSchedule = fetch("https://drive.google.com/uc?export=download&id=10dkEgfwi7b78LveJTLaLnvPtYVVhyX9D")
          .then(response => response.json());
      }
      return cachedFullSchedule;
    }

    /**
     * @returns {Date}
     */
    function getCurrentDateAndTime()
    {
      const now = new Date();

      // const fakeYear = 2025;
      // const fakeMonth = 9;
      // const fakeDay = 12;
      // const fakeHour = 11;
      // const fakeMinute = 30;
      // const now = new Date(fakeYear, fakeMonth - 1, fakeDay, fakeHour, fakeMinute, 0, 0);

      return now;
    }

    /**
     * Get the date string for the provided Date object.
     * 
     * @param {Date} date - The Date to get the date string for.
     * @returns {string}
     */
    function getDateString(date)
    {
      const nowMonthIndex = date.getMonth();
      const nowMonth = String(nowMonthIndex + 1).padStart(2, '0');
      const nowDay = String(date.getDate()).padStart(2, '0');
      return `${nowMonth}/${nowDay}`;
    }

    /**
     * Get the day of the week for the provided Date.
     * 
     * @param {Date} date - The Date to get the day of the week for.
     * @returns {string}
     */
    function getDayOfWeek(date)
    {
      return date.toLocaleDateString("en-US", { weekday: "long" });
    }

    /**
     * Get the schedule for the provided Date.
     * 
     * @param {Date} date - The date to get the day schedule for.
     * @returns {Promise<ScheduleBlock[]>}
     */
    function getDaySchedule(date) {
      return getFullSchedule().then(fullSchedule => {
        const dateString = getDateString(date);

        /** @type {ScheduleBlock[]} */
        let todaysSchedule = [];
        /** @type {string | undefined} */
        const specialDayScheduleName = fullSchedule.specialDays[dateString];
        if (specialDayScheduleName)
        {
          // console.log(`Looking for special schedule named "${specialDayScheduleName}..."`);
          /** @type {ScheduleBlock[] | undefined} */
          const specialDaySchedule = fullSchedule.specialSchedule[specialDayScheduleName];
          if (!specialDaySchedule)
          {
            // console.log(`Missing special day schedule for "${specialDayScheduleName}."`);
          }
          else
          {
            todaysSchedule = specialDaySchedule;
          }
        }
        else
        {
          const dayOfTheWeek = getDayOfWeek(date);
          todaysSchedule = fullSchedule.regularSchedule[dayOfTheWeek];
        }
        return todaysSchedule;
      });
    }

    /**
     * @param {Date} now
     * @param {string} scheduleTimeString
     * @returns {Date}
     */
    function parseTime(now, scheduleTimeString) {
      const [hour, minute] = scheduleTimeString.split(":").map(Number);
      const scheduleTimeDate = new Date(now);
      scheduleTimeDate.setHours(hour, minute, 0, 0);
      return scheduleTimeDate;
    }

    /**
     * Find the ScheduleBlocks that are active at the provided Date.
     * 
     * @param {Date} now - The current date and time.
     * @param {ScheduleBlock[]} todaysSchedule - The schedule for the provided Date.
     * @returns {ScheduleBlock[]}
     */
    function findCurrentBlocks(now, todaysSchedule)
    {
      /** @type {ScheduleBlock[]} */
      const currentBlocks = [];
      if (todaysSchedule && todaysSchedule.length > 0)
      {
        const todayStart = parseTime(now, todaysSchedule[0].start);
        const todayEnd = parseTime(now, todaysSchedule[todaysSchedule.length - 1].end);
        if (todayStart <= now && now < todayEnd)
        {
          for (let i = 0; i < todaysSchedule.length; i++) {
            const currentBlock = todaysSchedule[i];
            const currentBlockStartTime = parseTime(now, currentBlock.start);
            const currentBlockEndTime = parseTime(now, currentBlock.end);

            if (currentBlockStartTime <= now)
            {
              if (now < currentBlockEndTime)
              {
                currentBlocks.push(currentBlock);
              }
              else if (i < todaysSchedule.length - 1)
              {
                const nextBlock = todaysSchedule[i + 1];
                const nextBlockStartTime = parseTime(now, nextBlock.start);
                if (now < nextBlockStartTime)
                {
                  currentBlocks.push({ name: "Passing Period", start: currentBlock.end, end: nextBlock.start });
                }
              }
            }
          }
        }
      }

      if (currentBlocks.length === 0) {
        currentBlocks.push({ name: "No School", start: "", end: "" });
      }

      return currentBlocks;
    }

    function updateSchedule() {
      const now = getCurrentDateAndTime();
      getDaySchedule(now).then(todaysSchedule => {
        const currentBlocks = findCurrentBlocks(now, todaysSchedule);

        const containerElement = document.getElementById("container");
        if (!containerElement)
        {
          console.log(`Missing 'container' element!`);
        }
        else
        {
          containerElement.innerHTML = "";

          for (let i = 0; i < currentBlocks.length; i++)
          {
            const currentBlock = currentBlocks[i];

            /** @type {string} */
            let innerHtml = `<h1>${currentBlock.name}</h1>`;
            if (currentBlock.end)
            {
              const currentBlockEndTime = parseTime(now, currentBlock.end);
              const millisecondsUntilEnd = currentBlockEndTime.getTime() - now.getTime();
              const secondsUntilEnd = millisecondsUntilEnd / 1000;
              const minutesUntilEnd = Math.floor(secondsUntilEnd / 60);
              const seconds = Math.floor(secondsUntilEnd % 60);
              innerHtml += `<h2>Ends in ${minutesUntilEnd}m ${seconds}s</h2>`;
            }

            const blockDiv = document.createElement("div");
            blockDiv.className = "block";
            blockDiv.innerHTML = innerHtml;

            containerElement.appendChild(blockDiv);
          }
        }
      });
    }

    updateSchedule();
    setInterval(updateSchedule, 1000);
  </script>
</body>
</html>
